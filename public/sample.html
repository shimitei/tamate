<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>test</title>
  <link href="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-MCw98/SFnGE8fJT3GXwEOngsV7Zt27NXFoaoApmYm81iuXoPkFOJwJ8ERdknLPMO" crossorigin="anonymous">
  <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.3.1/css/solid.css" integrity="sha384-VGP9aw4WtGH/uPAOseYxZ+Vz/vaTb1ehm1bwx92Fm8dTrE+3boLfF1SpAtB1z7HW" crossorigin="anonymous">
  <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.3.1/css/brands.css" integrity="sha384-rf1bqOAj3+pw6NqYrtaE1/4Se2NBwkIfeYbsFdtiR6TQz0acWiwJbv1IM/Nt/ite" crossorigin="anonymous">
  <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.3.1/css/fontawesome.css" integrity="sha384-1rquJLNOM3ijoueaaeS5m+McXPJCGdr5HcA03/VHXxcp2kX2sUrQDmFc3jR5i/C7" crossorigin="anonymous">
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
</head>
<body>
  <div class="container">
    <div class="row">
      <div id="root" class="list-group col-6">
      </div>
      <div id="dir" class="list-group col-6">
      </div>
    </div>
  </div>
  <script>
$(function() {
  var getIcon = function(meta){
    var result;
    if (meta.isFolder) {
      result = ' fas fa-folder-open';
    } else if (meta.isInfo) {
      result = ' fas fa-info-circle';
    } else {
      switch(meta.ext){
        case '.zip': result = ' fas fa-file-archive'; break;
        case '.dmg': result = ' fab fa-apple'; break;
        case '.txt': result = ' fas fa-file-alt'; break;
        default: result = ' fas fa-file';
      }
    }
    return result;
  }
  var getMeta = function(item){
    var tag = item['.tag'];
    return {
      tag: tag,
      isFolder: (tag == 'folder'),
      isInfo: (item.name.indexOf('readme.') == 0),
      ext: item.name.slice(-4).toLowerCase(),
    };
  }
  var makeATag = function(item){
    var meta = getMeta(item);
    var href;
    if (meta.isFolder) {
      href = '#';
    } else if (meta.isInfo) {
      href = '/api/more?path=';
    } else {
      href = '/api/dl?path=';
    }
    var icon = getIcon(meta);
    return $("<a>",{
      "id": item.name,
      "href": href + item.path_display,
      "class": 'list-group-item list-group-item-action ' + meta.tag + icon,
      text:  ' ' + item.name,
      target: '_blank'
      });
  }
  var ls = function(path, to){
    $.getJSON('/api/ls', {path: path})
      .done(function(data) {
        $(to).empty();
        data.entries.forEach(function(item){
          $(to).append(makeATag(item));
        });
      });
  }
  var link = function(path, aid){
    $.getJSON('/api/link', {path: path})
      .done(function(data) {
        var sid = '#' + aid;
        $(sid).removeClass('file');
        $(sid).attr('href', data.url);
        $(sid).text(aid + ' download');
      });
  }
  var getPath = function(event){
    return event.target.href.split('#')[1];
  }

  ls('', '#root');

  $(document).on('click','.folder',function(event){
    ls(getPath(event), '#dir');
    return false;
  });
});
</script>
</body>
</html>
